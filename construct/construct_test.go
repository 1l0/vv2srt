package construct

import (
	"encoding/json"
	"testing"
	"time"

	"github.com/1l0/vv2srt/model"
)

const (
	testAdjAivis     = 60000000.0
	testAdjVoicevox  = -30000000.0
	testBoolAivis    = true
	testBoolVoicevox = false
)

func TestConstruct(t *testing.T) {
	t.Run("voicevox 1", func(t *testing.T) {

		var proj model.Project
		json.Unmarshal([]byte(modelVoicevox1), &proj)
		sub, err := generateSubtitles(&proj, testAdjVoicevox, testBoolVoicevox)
		if err != nil {
			t.Fatal(err)
		}
		cap := sub.Captions[len(sub.Captions)-1]
		if cap.Seq != 8 {
			t.Fatalf("cap.Seq != 8: %d", cap.Seq)
		}
		if cap.Start != time.Date(0000, 1, 1, 0, 0, 11, 179683926, time.UTC) {
			t.Fatalf("cap.start != 0000-01-01 00:00:11.179683926 +0000 UTC: %v", cap.Start)
		}
		if cap.End != time.Date(0000, 1, 1, 0, 0, 12, 833412428, time.UTC) {
			t.Fatalf("cap.start != 0000-01-01 00:00:12.833412428 +0000 UTC: %v", cap.End)
		}
		if len(cap.Text) < 1 || cap.Text[0] != "今日も楽しくいきましょう。" {
			t.Fatal("text mismatch")
		}
	})
}

const modelVoicevox1 = `
{"appVersion":"0.23.0","talk":{"audioKeys":["1832ddc6-874e-4f0d-a128-d1d0178fb21f","9b7cb4fc-a10a-4cc1-af1a-c060f804084a","d46ef6d1-3fef-4211-aade-7b215ae3e4d1","da4dc448-cb1f-4323-94c4-d690b6b90d13","7e5a9198-6502-439b-9db5-3c67a59da1f6","c71d5477-c247-40dc-b1c2-ae992b1b242f","495dec7a-e478-4f58-ac56-6b7466cb0bdf","d3eba6fd-57ec-40d3-b1a6-7ad67bd8723e"],"audioItems":{"1832ddc6-874e-4f0d-a128-d1d0178fb21f":{"text":"テスト音声です。","voice":{"engineId":"074fc39e-678b-4c13-8916-ffca8d505d1d","speakerId":"7ffcb7ce-00ec-4bdc-82cd-45a8889e43ff","styleId":2},"query":{"accentPhrases":[{"moras":[{"text":"テ","vowel":"e","vowelLength":0.08644835650920868,"pitch":5.549513339996338,"consonant":"t","consonantLength":0.05478108674287796},{"text":"ス","vowel":"U","vowelLength":0.06847720593214035,"pitch":0,"consonant":"s","consonantLength":0.03383197635412216},{"text":"ト","vowel":"o","vowelLength":0.08807443082332611,"pitch":6.028382778167725,"consonant":"t","consonantLength":0.07110422849655151},{"text":"オ","vowel":"o","vowelLength":0.11608389019966125,"pitch":6.084438323974609},{"text":"ン","vowel":"N","vowelLength":0.07087746262550354,"pitch":6.080620765686035},{"text":"セ","vowel":"e","vowelLength":0.07443655282258987,"pitch":5.8990702629089355,"consonant":"s","consonantLength":0.06485532224178314},{"text":"エ","vowel":"e","vowelLength":0.057995595037937164,"pitch":5.675220489501953},{"text":"デ","vowel":"e","vowelLength":0.08930515497922897,"pitch":5.483846187591553,"consonant":"d","consonantLength":0.048604801297187805},{"text":"ス","vowel":"U","vowelLength":0.09856957942247391,"pitch":0,"consonant":"s","consonantLength":0.06386727094650269}],"accent":4,"isInterrogative":false}],"speedScale":1,"pitchScale":0,"intonationScale":1,"volumeScale":1,"pauseLengthScale":1,"prePhonemeLength":0.1,"postPhonemeLength":0.1,"outputSamplingRate":24000,"outputStereo":false,"kana":""},"presetKey":"0f22aad8-56d2-4b2f-a8e0-67acd5671580"},"9b7cb4fc-a10a-4cc1-af1a-c060f804084a":{"text":"今日も楽しくいきましょう。","voice":{"engineId":"074fc39e-678b-4c13-8916-ffca8d505d1d","speakerId":"7ffcb7ce-00ec-4bdc-82cd-45a8889e43ff","styleId":2},"query":{"accentPhrases":[{"moras":[{"text":"キョ","vowel":"o","vowelLength":0.08692564815282822,"pitch":5.7546067237854,"consonant":"ky","consonantLength":0.08895937353372574},{"text":"オ","vowel":"o","vowelLength":0.07986718416213989,"pitch":5.8091278076171875},{"text":"モ","vowel":"o","vowelLength":0.07685127854347229,"pitch":5.6050567626953125,"consonant":"m","consonantLength":0.04783201590180397}],"accent":1,"isInterrogative":false},{"moras":[{"text":"タ","vowel":"a","vowelLength":0.06528859585523605,"pitch":5.451237201690674,"consonant":"t","consonantLength":0.045342352241277695},{"text":"ノ","vowel":"o","vowelLength":0.0814204141497612,"pitch":5.667622089385986,"consonant":"n","consonantLength":0.048389825969934464},{"text":"シ","vowel":"I","vowelLength":0.06400025635957718,"pitch":0,"consonant":"sh","consonantLength":0.03719403222203255},{"text":"ク","vowel":"u","vowelLength":0.06541640311479568,"pitch":5.962754726409912,"consonant":"k","consonantLength":0.0735851302742958},{"text":"イ","vowel":"i","vowelLength":0.0811275988817215,"pitch":5.928925037384033},{"text":"キ","vowel":"i","vowelLength":0.053699035197496414,"pitch":5.939727306365967,"consonant":"k","consonantLength":0.06314125657081604},{"text":"マ","vowel":"a","vowelLength":0.08699707686901093,"pitch":5.919630527496338,"consonant":"m","consonantLength":0.0463370755314827},{"text":"ショ","vowel":"o","vowelLength":0.08285629749298096,"pitch":5.941473960876465,"consonant":"sh","consonantLength":0.09972898662090302},{"text":"オ","vowel":"o","vowelLength":0.10876866430044174,"pitch":5.726274490356445}],"accent":8,"isInterrogative":false}],"speedScale":1,"pitchScale":0,"intonationScale":1,"volumeScale":1,"pauseLengthScale":1,"prePhonemeLength":0.1,"postPhonemeLength":0.1,"outputSamplingRate":24000,"outputStereo":false,"kana":""},"presetKey":"0f22aad8-56d2-4b2f-a8e0-67acd5671580"},"d46ef6d1-3fef-4211-aade-7b215ae3e4d1":{"text":"今日も楽しくいきましょう。","voice":{"engineId":"074fc39e-678b-4c13-8916-ffca8d505d1d","speakerId":"7ffcb7ce-00ec-4bdc-82cd-45a8889e43ff","styleId":2},"query":{"accentPhrases":[{"moras":[{"text":"キョ","vowel":"o","vowelLength":0.08692564815282822,"pitch":5.7546067237854,"consonant":"ky","consonantLength":0.08895937353372574},{"text":"オ","vowel":"o","vowelLength":0.07986718416213989,"pitch":5.8091278076171875},{"text":"モ","vowel":"o","vowelLength":0.07685127854347229,"pitch":5.6050567626953125,"consonant":"m","consonantLength":0.04783201590180397}],"accent":1,"isInterrogative":false},{"moras":[{"text":"タ","vowel":"a","vowelLength":0.06528859585523605,"pitch":5.451237201690674,"consonant":"t","consonantLength":0.045342352241277695},{"text":"ノ","vowel":"o","vowelLength":0.0814204141497612,"pitch":5.667622089385986,"consonant":"n","consonantLength":0.048389825969934464},{"text":"シ","vowel":"I","vowelLength":0.06400025635957718,"pitch":0,"consonant":"sh","consonantLength":0.03719403222203255},{"text":"ク","vowel":"u","vowelLength":0.06541640311479568,"pitch":5.962754726409912,"consonant":"k","consonantLength":0.0735851302742958},{"text":"イ","vowel":"i","vowelLength":0.0811275988817215,"pitch":5.928925037384033},{"text":"キ","vowel":"i","vowelLength":0.053699035197496414,"pitch":5.939727306365967,"consonant":"k","consonantLength":0.06314125657081604},{"text":"マ","vowel":"a","vowelLength":0.08699707686901093,"pitch":5.919630527496338,"consonant":"m","consonantLength":0.0463370755314827},{"text":"ショ","vowel":"o","vowelLength":0.08285629749298096,"pitch":5.941473960876465,"consonant":"sh","consonantLength":0.09972898662090302},{"text":"オ","vowel":"o","vowelLength":0.10876866430044174,"pitch":5.726274490356445}],"accent":8,"isInterrogative":false}],"speedScale":1,"pitchScale":0,"intonationScale":1,"volumeScale":1,"pauseLengthScale":1,"prePhonemeLength":0.1,"postPhonemeLength":0.1,"outputSamplingRate":24000,"outputStereo":false,"kana":""},"presetKey":"0f22aad8-56d2-4b2f-a8e0-67acd5671580"},"da4dc448-cb1f-4323-94c4-d690b6b90d13":{"text":"今日も楽しくいきましょう。","voice":{"engineId":"074fc39e-678b-4c13-8916-ffca8d505d1d","speakerId":"7ffcb7ce-00ec-4bdc-82cd-45a8889e43ff","styleId":2},"query":{"accentPhrases":[{"moras":[{"text":"キョ","vowel":"o","vowelLength":0.08692564815282822,"pitch":5.7546067237854,"consonant":"ky","consonantLength":0.08895937353372574},{"text":"オ","vowel":"o","vowelLength":0.07986718416213989,"pitch":5.8091278076171875},{"text":"モ","vowel":"o","vowelLength":0.07685127854347229,"pitch":5.6050567626953125,"consonant":"m","consonantLength":0.04783201590180397}],"accent":1,"isInterrogative":false},{"moras":[{"text":"タ","vowel":"a","vowelLength":0.06528859585523605,"pitch":5.451237201690674,"consonant":"t","consonantLength":0.045342352241277695},{"text":"ノ","vowel":"o","vowelLength":0.0814204141497612,"pitch":5.667622089385986,"consonant":"n","consonantLength":0.048389825969934464},{"text":"シ","vowel":"I","vowelLength":0.06400025635957718,"pitch":0,"consonant":"sh","consonantLength":0.03719403222203255},{"text":"ク","vowel":"u","vowelLength":0.06541640311479568,"pitch":5.962754726409912,"consonant":"k","consonantLength":0.0735851302742958},{"text":"イ","vowel":"i","vowelLength":0.0811275988817215,"pitch":5.928925037384033},{"text":"キ","vowel":"i","vowelLength":0.053699035197496414,"pitch":5.939727306365967,"consonant":"k","consonantLength":0.06314125657081604},{"text":"マ","vowel":"a","vowelLength":0.08699707686901093,"pitch":5.919630527496338,"consonant":"m","consonantLength":0.0463370755314827},{"text":"ショ","vowel":"o","vowelLength":0.08285629749298096,"pitch":5.941473960876465,"consonant":"sh","consonantLength":0.09972898662090302},{"text":"オ","vowel":"o","vowelLength":0.10876866430044174,"pitch":5.726274490356445}],"accent":8,"isInterrogative":false}],"speedScale":1,"pitchScale":0,"intonationScale":1,"volumeScale":1,"pauseLengthScale":1,"prePhonemeLength":0.1,"postPhonemeLength":0.1,"outputSamplingRate":24000,"outputStereo":false,"kana":""},"presetKey":"0f22aad8-56d2-4b2f-a8e0-67acd5671580"},"7e5a9198-6502-439b-9db5-3c67a59da1f6":{"text":"今日も楽しくいきましょう。","voice":{"engineId":"074fc39e-678b-4c13-8916-ffca8d505d1d","speakerId":"7ffcb7ce-00ec-4bdc-82cd-45a8889e43ff","styleId":2},"query":{"accentPhrases":[{"moras":[{"text":"キョ","vowel":"o","vowelLength":0.08692564815282822,"pitch":5.7546067237854,"consonant":"ky","consonantLength":0.08895937353372574},{"text":"オ","vowel":"o","vowelLength":0.07986718416213989,"pitch":5.8091278076171875},{"text":"モ","vowel":"o","vowelLength":0.07685127854347229,"pitch":5.6050567626953125,"consonant":"m","consonantLength":0.04783201590180397}],"accent":1,"isInterrogative":false},{"moras":[{"text":"タ","vowel":"a","vowelLength":0.06528859585523605,"pitch":5.451237201690674,"consonant":"t","consonantLength":0.045342352241277695},{"text":"ノ","vowel":"o","vowelLength":0.0814204141497612,"pitch":5.667622089385986,"consonant":"n","consonantLength":0.048389825969934464},{"text":"シ","vowel":"I","vowelLength":0.06400025635957718,"pitch":0,"consonant":"sh","consonantLength":0.03719403222203255},{"text":"ク","vowel":"u","vowelLength":0.06541640311479568,"pitch":5.962754726409912,"consonant":"k","consonantLength":0.0735851302742958},{"text":"イ","vowel":"i","vowelLength":0.0811275988817215,"pitch":5.928925037384033},{"text":"キ","vowel":"i","vowelLength":0.053699035197496414,"pitch":5.939727306365967,"consonant":"k","consonantLength":0.06314125657081604},{"text":"マ","vowel":"a","vowelLength":0.08699707686901093,"pitch":5.919630527496338,"consonant":"m","consonantLength":0.0463370755314827},{"text":"ショ","vowel":"o","vowelLength":0.08285629749298096,"pitch":5.941473960876465,"consonant":"sh","consonantLength":0.09972898662090302},{"text":"オ","vowel":"o","vowelLength":0.10876866430044174,"pitch":5.726274490356445}],"accent":8,"isInterrogative":false}],"speedScale":1,"pitchScale":0,"intonationScale":1,"volumeScale":1,"pauseLengthScale":1,"prePhonemeLength":0.1,"postPhonemeLength":0.1,"outputSamplingRate":24000,"outputStereo":false,"kana":""},"presetKey":"0f22aad8-56d2-4b2f-a8e0-67acd5671580"},"c71d5477-c247-40dc-b1c2-ae992b1b242f":{"text":"今日も楽しくいきましょう。","voice":{"engineId":"074fc39e-678b-4c13-8916-ffca8d505d1d","speakerId":"7ffcb7ce-00ec-4bdc-82cd-45a8889e43ff","styleId":2},"query":{"accentPhrases":[{"moras":[{"text":"キョ","vowel":"o","vowelLength":0.08692564815282822,"pitch":5.7546067237854,"consonant":"ky","consonantLength":0.08895937353372574},{"text":"オ","vowel":"o","vowelLength":0.07986718416213989,"pitch":5.8091278076171875},{"text":"モ","vowel":"o","vowelLength":0.07685127854347229,"pitch":5.6050567626953125,"consonant":"m","consonantLength":0.04783201590180397}],"accent":1,"isInterrogative":false},{"moras":[{"text":"タ","vowel":"a","vowelLength":0.06528859585523605,"pitch":5.451237201690674,"consonant":"t","consonantLength":0.045342352241277695},{"text":"ノ","vowel":"o","vowelLength":0.0814204141497612,"pitch":5.667622089385986,"consonant":"n","consonantLength":0.048389825969934464},{"text":"シ","vowel":"I","vowelLength":0.06400025635957718,"pitch":0,"consonant":"sh","consonantLength":0.03719403222203255},{"text":"ク","vowel":"u","vowelLength":0.06541640311479568,"pitch":5.962754726409912,"consonant":"k","consonantLength":0.0735851302742958},{"text":"イ","vowel":"i","vowelLength":0.0811275988817215,"pitch":5.928925037384033},{"text":"キ","vowel":"i","vowelLength":0.053699035197496414,"pitch":5.939727306365967,"consonant":"k","consonantLength":0.06314125657081604},{"text":"マ","vowel":"a","vowelLength":0.08699707686901093,"pitch":5.919630527496338,"consonant":"m","consonantLength":0.0463370755314827},{"text":"ショ","vowel":"o","vowelLength":0.08285629749298096,"pitch":5.941473960876465,"consonant":"sh","consonantLength":0.09972898662090302},{"text":"オ","vowel":"o","vowelLength":0.10876866430044174,"pitch":5.726274490356445}],"accent":8,"isInterrogative":false}],"speedScale":1,"pitchScale":0,"intonationScale":1,"volumeScale":1,"pauseLengthScale":1,"prePhonemeLength":0.1,"postPhonemeLength":0.1,"outputSamplingRate":24000,"outputStereo":false,"kana":""},"presetKey":"0f22aad8-56d2-4b2f-a8e0-67acd5671580"},"495dec7a-e478-4f58-ac56-6b7466cb0bdf":{"text":"今日も楽しくいきましょう。","voice":{"engineId":"074fc39e-678b-4c13-8916-ffca8d505d1d","speakerId":"7ffcb7ce-00ec-4bdc-82cd-45a8889e43ff","styleId":2},"query":{"accentPhrases":[{"moras":[{"text":"キョ","vowel":"o","vowelLength":0.08692564815282822,"pitch":5.7546067237854,"consonant":"ky","consonantLength":0.08895937353372574},{"text":"オ","vowel":"o","vowelLength":0.07986718416213989,"pitch":5.8091278076171875},{"text":"モ","vowel":"o","vowelLength":0.07685127854347229,"pitch":5.6050567626953125,"consonant":"m","consonantLength":0.04783201590180397}],"accent":1,"isInterrogative":false},{"moras":[{"text":"タ","vowel":"a","vowelLength":0.06528859585523605,"pitch":5.451237201690674,"consonant":"t","consonantLength":0.045342352241277695},{"text":"ノ","vowel":"o","vowelLength":0.0814204141497612,"pitch":5.667622089385986,"consonant":"n","consonantLength":0.048389825969934464},{"text":"シ","vowel":"I","vowelLength":0.06400025635957718,"pitch":0,"consonant":"sh","consonantLength":0.03719403222203255},{"text":"ク","vowel":"u","vowelLength":0.06541640311479568,"pitch":5.962754726409912,"consonant":"k","consonantLength":0.0735851302742958},{"text":"イ","vowel":"i","vowelLength":0.0811275988817215,"pitch":5.928925037384033},{"text":"キ","vowel":"i","vowelLength":0.053699035197496414,"pitch":5.939727306365967,"consonant":"k","consonantLength":0.06314125657081604},{"text":"マ","vowel":"a","vowelLength":0.08699707686901093,"pitch":5.919630527496338,"consonant":"m","consonantLength":0.0463370755314827},{"text":"ショ","vowel":"o","vowelLength":0.08285629749298096,"pitch":5.941473960876465,"consonant":"sh","consonantLength":0.09972898662090302},{"text":"オ","vowel":"o","vowelLength":0.10876866430044174,"pitch":5.726274490356445}],"accent":8,"isInterrogative":false}],"speedScale":1,"pitchScale":0,"intonationScale":1,"volumeScale":1,"pauseLengthScale":1,"prePhonemeLength":0.1,"postPhonemeLength":0.1,"outputSamplingRate":24000,"outputStereo":false,"kana":""},"presetKey":"0f22aad8-56d2-4b2f-a8e0-67acd5671580"},"d3eba6fd-57ec-40d3-b1a6-7ad67bd8723e":{"text":"今日も楽しくいきましょう。","voice":{"engineId":"074fc39e-678b-4c13-8916-ffca8d505d1d","speakerId":"7ffcb7ce-00ec-4bdc-82cd-45a8889e43ff","styleId":2},"query":{"accentPhrases":[{"moras":[{"text":"キョ","vowel":"o","vowelLength":0.08692564815282822,"pitch":5.7546067237854,"consonant":"ky","consonantLength":0.08895937353372574},{"text":"オ","vowel":"o","vowelLength":0.07986718416213989,"pitch":5.8091278076171875},{"text":"モ","vowel":"o","vowelLength":0.07685127854347229,"pitch":5.6050567626953125,"consonant":"m","consonantLength":0.04783201590180397}],"accent":1,"isInterrogative":false},{"moras":[{"text":"タ","vowel":"a","vowelLength":0.06528859585523605,"pitch":5.451237201690674,"consonant":"t","consonantLength":0.045342352241277695},{"text":"ノ","vowel":"o","vowelLength":0.0814204141497612,"pitch":5.667622089385986,"consonant":"n","consonantLength":0.048389825969934464},{"text":"シ","vowel":"I","vowelLength":0.06400025635957718,"pitch":0,"consonant":"sh","consonantLength":0.03719403222203255},{"text":"ク","vowel":"u","vowelLength":0.06541640311479568,"pitch":5.962754726409912,"consonant":"k","consonantLength":0.0735851302742958},{"text":"イ","vowel":"i","vowelLength":0.0811275988817215,"pitch":5.928925037384033},{"text":"キ","vowel":"i","vowelLength":0.053699035197496414,"pitch":5.939727306365967,"consonant":"k","consonantLength":0.06314125657081604},{"text":"マ","vowel":"a","vowelLength":0.08699707686901093,"pitch":5.919630527496338,"consonant":"m","consonantLength":0.0463370755314827},{"text":"ショ","vowel":"o","vowelLength":0.08285629749298096,"pitch":5.941473960876465,"consonant":"sh","consonantLength":0.09972898662090302},{"text":"オ","vowel":"o","vowelLength":0.10876866430044174,"pitch":5.726274490356445}],"accent":8,"isInterrogative":false}],"speedScale":1,"pitchScale":0,"intonationScale":1,"volumeScale":1,"pauseLengthScale":1,"prePhonemeLength":0.1,"postPhonemeLength":0.1,"outputSamplingRate":24000,"outputStereo":false,"kana":""},"presetKey":"0f22aad8-56d2-4b2f-a8e0-67acd5671580"}}},"song":{"tpqn":480,"tempos":[{"position":0,"bpm":120}],"timeSignatures":[{"measureNumber":1,"beats":4,"beatType":4}],"tracks":{"e17dc83f-b34a-47be-a036-4db45c3d4037":{"name":"無名トラック","keyRangeAdjustment":0,"volumeRangeAdjustment":0,"notes":[],"pitchEditData":[],"solo":false,"mute":false,"gain":1,"pan":0}},"trackOrder":["e17dc83f-b34a-47be-a036-4db45c3d4037"]}}
`
